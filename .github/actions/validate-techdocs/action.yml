name: "Validate Techdocs"
description: "Runs validation against mkdocs and techdocs to ensure documentation can be created"
inputs:
  repository:
    description: "Name of repository"
    required: true
  descriptor-file:
    description: "Name of catalog entity descriptor file"
    required: false
  namespace:
    description: "Namespace of entity; used as namespace for --entity <namespace/kind/name>"
    default: "default"
    required: false
  token:
    description: "Personal Access token to pull source repository"
    required: false
  strict-mode:
    description: "Used to enable or disables strict flag for validation"
    default: "true"
    required: false
outputs:
  results:
    description: "Results of validation script"
    value: ${{ steps.validation.outputs.RESULTS }}
runs:
  using: "composite"
  steps:
    - name: Set AuthZ token in link checker config
      uses: sergeysova/jq-action@v2.3.0
      id: set-token
      with:
        cmd: "jq --arg v 'token ${{ inputs.token }}' '.httpHeaders[] .headers.Authorization=$v' -r department-of-veterans-affairs/lighthouse-github-actions/mlc_config.json"
        multiline: true
    - name: Create Link Checker Config
      run: |
        echo '${{ steps.set-token.outputs.value }}' > department-of-veterans-affairs/lighthouse-github-actions/mlc_config.json
        sed -i 's/%0A/\n/' department-of-veterans-affairs/lighthouse-github-actions/mlc_config.json > department-of-veterans-affairs/lighthouse-github-actions/mlc_config.json
        cat mlc_config.json
      shell: bash
    - name: Check Techdoc Links
      id: checkmd
      uses: gaurav-nelson/github-action-markdown-link-check@1.0.15
      with:
        use-verbose-mode: 'yes'
        config-file: './department-of-veterans-affairs/lighthouse-github-actions/mlc_config.json'
    - name: Setup validation args
      id: args
      run: |
        args=""
        if [[ "${{ inputs.strict-mode }}" == "true" ]]; then
          args+="--strict "
        fi
        echo "${args}"
        echo "args=${args}" >> $GITHUB_OUTPUT
      shell: bash
    - name: Run validation script
      id: validation
      env:
        REPO: ${{ inputs.repository }}
        ENTITY_FILE: ${{ inputs.descriptor-file }}
        NAMESPACE: ${{ inputs.namespace }}
        TOKEN: ${{ inputs.token }}
        ARGS: ${{ steps.args.outputs.args }}
      run: |
        cd ${{ inputs.repository }}
        /bin/bash <(curl -s https://${{ inputs.token }}@raw.githubusercontent.com/department-of-veterans-affairs/lighthouse-github-actions/main/scripts/validate-techdocs.sh)
      shell: bash
    - name: Check for warnings
      if: ${{ inputs.strict-mode == 'true' }}
      run: |
        if echo "${{ steps.validation.outputs.RESULTS }}" | grep -i "warning"; then
          echo -e "Validation Error:\n${{ steps.validation.outputs.RESULTS }}";
          exit 1;
        fi
      shell: bash
    - name: Check for errors
      run: |
        if echo "${{ steps.validation.outputs.RESULTS }}" | grep -i "error"; then
          if echo "${{ steps.validation.outputs.RESULTS }}" | grep -i "failed to run plantuml"; then
            echo -e "Validation Error: Unable to create diagram with Plantuml.\nMake sure to use the @startuml and @enduml notation."
          fi
          exit 1;
        fi
      shell: bash
